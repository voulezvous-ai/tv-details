name: "Normalize & Rename Markdown Files"

on:
  push:
    paths:
      - '**/*.md'
  workflow_dispatch:

jobs:
  rename:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Rename Markdown Files
        run: |
          # Define emoji mappings for file prefixes
          declare -A emoji_map=(
            ["0"]="ğŸ—‚ï¸"
            ["1"]="ğŸ“¥"
            ["2"]="ğŸš€"
            ["3"]="ğŸ”—"
            ["4"]="ğŸ³"
            ["5"]="ğŸ§©"
            ["6"]="âš™ï¸"
            ["7"]="ğŸ”§"
            ["8"]="âœ…"
            ["9"]="ğŸ“Š"
            ["10"]="ğŸ”’"
            ["11"]="ğŸ”„"
            ["12.1"]="ğŸ”"
            ["12.2"]="ğŸ¤–"
            ["12.3"]="ğŸ§¹"
            ["12.4"]="ğŸ›ï¸"
            ["12.5"]="ğŸ–¼ï¸"
            ["12.5.1"]="ğŸ§ª"
            ["12.6"]="ğŸ“¦"
            ["12.7"]="ğŸ”‘"
            ["12.8"]="ğŸ›¡ï¸"
            ["12.9"]="ğŸš¨"
            ["12.10"]="ğŸ“ˆ"
            ["12.11"]="â±ï¸"
            ["12.12"]="ğŸ“–"
            ["13.1"]="ğŸŒ"
            ["13.2"]="âš–ï¸"
            ["13.3"]="ğŸ”„"
            ["13.4"]="ğŸ’¡"
            ["13.5"]="ğŸ“œ"
            ["13.6"]="ğŸ§©"
            ["13.7"]="ğŸ‰"
          )

          # Iterate over all .md files and rename them
          for file in $(find . -type f -name "*.md" ! -path "./node_modules/*" ! -path "./.github/*" ! -path "./scripts/*"); do
            # Extract filename and path components
            filename=$(basename "$file" .md)
            filepath=$(dirname "$file")

            # Handle special case for the master blueprint
            if [[ "$filename" =~ ^VV-Video-AI-System ]]; then
              new_filename="ğŸ—‚ï¸ 0: VV Video AI System Master Blueprint V2.2.md"
              mv "$file" "$filepath/$new_filename"
              echo "Renamed $file â†’ $new_filename"
              continue
            fi

            # Extract key and title
            if [[ "$filename" =~ ^([0-9]+(\.[0-9]+)*)([-:\s]*(.*))?$ ]]; then
              key="${BASH_REMATCH[1]}"
              title="${BASH_REMATCH[4]}"
            else
              echo "Skipping $file (no matching pattern)"
              continue
            fi

            # Clean up title: Remove emojis, trim spaces, normalize
            title=$(echo "$title" | sed -E 's/[\p{Emoji_Presentation}\p{Emoji}\uFE0F]//g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            title=$(echo "$title" | sed -r 's/[^a-zA-Z0-9]+/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1' OFS=" ")

            # Map emoji for the key
            emoji="${emoji_map[$key]}"
            if [[ -z "$emoji" ]]; then
              echo "No emoji mapping for key $key, skipping $file"
              continue
            fi

            # Construct new filename
            new_filename="$emoji $key: $title.md"
            mv "$file" "$filepath/$new_filename"
            echo "Renamed $file â†’ $new_filename"
          done

      - name: Commit & Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "ci: normalize & rename markdown files"
            git push
          else
            echo "âœ… No files to rename."
