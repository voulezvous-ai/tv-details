Okay, let's do a comprehensive expansion of section `12.8 üõ°Ô∏è Estrat√©gia de Backup e Recupera√ß√£o de Dados`.

Here's a more detailed version. I'll try to cover all the aspects you mentioned and make it a robust plan.

---

## 12.8 üõ°Ô∏è Estrat√©gia de Backup e Recupera√ß√£o de Dados

**Objetivo:** Definir, documentar e implementar um plano robusto e test√°vel de backup e recupera√ß√£o para todos os dados cr√≠ticos do `VV-Video-AI-System`, garantindo a continuidade operacional e a integridade dos dados em caso de falhas, desastres ou corrup√ß√£o.

---

### 1. Dados Cr√≠ticos para Backup

A identifica√ß√£o precisa dos dados cr√≠ticos √© o primeiro passo. Os seguintes componentes s√£o essenciais para a funcionalidade e o hist√≥rico do sistema:

1.  **Dados de M√≠dia e Processamento (`${VIDEO_STORAGE_ROOT}`):**
    *   `input/`: V√≠deos brutos aguardando processamento.
    *   `raw/`: C√≥pias originais dos v√≠deos capturados (se esta pol√≠tica for mantida).
    *   `processed/`: V√≠deos que passaram por todo o pipeline.
    *   `tv_curado/`: Playlists e v√≠deos selecionados para exibi√ß√£o nas UIs.
    *   `analytic/`: Arquivos JSON com os resultados da an√°lise de `scan_video.py`.
    *   `summaries/`: Arquivos JSON com os sum√°rios gerados por `summarize_scene.py`.
    *   `loglines/`: Arquivos JSON e MD com as LogLines geradas e assinadas.
    *   `playlists/`: Arquivos JSON das playlists geradas por `tv_scheduler.py`.
    *   `fallback/`: Assets de fallback (geralmente est√°ticos, mas inclu√≠dos por completude e para garantir que personaliza√ß√µes sejam salvas).
    *   `corrupted/`: Arquivos identificados como problem√°ticos (backup pode ser √∫til para an√°lise forense).

2.  **Logs da Aplica√ß√£o e do Sistema:**
    *   `logs/app.log`: Log principal da aplica√ß√£o e dos scripts.
    *   `logs/cleanup_*.log`: Logs espec√≠ficos dos scripts de limpeza.
    *   `logs/cron_*.log`: Logs da execu√ß√£o dos cronjobs.
    *   Logs de containers Docker: Se persistidos em volumes dedicados e n√£o cobertos por `logs/app.log` (e.g., logs de NGINX, Prometheus se adicionado).

3.  **Estado Persistente da Aplica√ß√£o:**
    *   **Arquivo de estado do `orchestrator.py`**: Conforme definido em `12.4` (e.g., `orchestrator_data/processed_videos.txt` ou `orchestrator_data/orchestrator_db.sqlite`). Essencial para evitar reprocessamento.
    *   **Banco de Dados SQLite**: Se qualquer outro componente utilizar SQLite para persist√™ncia (al√©m do orquestrador).
    *   **Estado do Modelo BitNet**: Conforme definido em `12.6`, o `model_manifest.json` e potencialmente o arquivo `.current_model_info.json` local. Os pr√≥prios arquivos do modelo s√£o grandes e podem ser recuperados via `bootstrap.py`, mas o manifesto que dita qual vers√£o usar √© cr√≠tico.

4.  **Arquivos de Configura√ß√£o:**
    *   `.env`: Cont√©m segredos e configura√ß√µes de ambiente (ver `12.7` para gest√£o segura, mas o arquivo em si no servidor precisa ser backupado se n√£o for gerado dinamicamente a cada deploy).
    *   `docker-compose.yml`: Define a arquitetura dos servi√ßos.
    *   `vv-signature.json`: Manifesto de integridade do sistema.
    *   `config.yaml` dos m√≥dulos (e.g., `tv_scheduler/config.yaml`, `vv_ingest/config.yaml`).
    *   Configura√ß√µes do NGINX (e.g., `/etc/nginx/sites-available/vv-video-ai`, chaves SSL/TLS se gerenciadas manualmente e n√£o via Certbot que tem seu pr√≥prio mecanismo).
    *   Defini√ß√µes de Cronjobs (e.g., `crontab -l` do usu√°rio relevante).
    *   Scripts de sistema (e.g., `install.sh`, `bootstrap.py`, `vv-video-ai.service`). Embora estejam no Git, uma c√≥pia local como parte do backup do sistema pode acelerar a recupera√ß√£o do estado exato.

5.  **(Opcional) Docker Volumes Nomeados:** Se houver volumes nomeados que n√£o mapeiam diretamente para `VIDEO_STORAGE_ROOT` e cont√™m dados importantes (e.g., dados de um banco de dados rodando em container, dados do Prometheus).

---

### 2. Ferramentas e Tecnologias de Backup

A escolha da ferramenta depende dos requisitos de RPO/RTO, do destino do backup, e da complexidade da infraestrutura.

*   **`rsync`**:
    *   **Pr√≥s**: Simples, amplamente dispon√≠vel, eficiente para transfer√™ncias incrementais (com `--link-dest` para snapshots ou `--checksum`), bom para backups locais ou para servidores acess√≠veis via SSH.
    *   **Contras**: N√£o possui recursos embutidos de deduplica√ß√£o avan√ßada, versionamento complexo de snapshots, ou criptografia (precisa ser combinada com outras ferramentas como `gpg`). N√£o gerencia o cat√°logo de backup.
    *   **Uso**: Ideal para replicar √°rvores de diret√≥rios para um disco secund√°rio, NAS ou servidor de backup.

*   **`restic`**:
    *   **Pr√≥s**: Moderno, seguro (criptografia ponta-a-ponta), eficiente (deduplica√ß√£o), suporta m√∫ltiplos backends (local, SFTP, S3, Azure Blob, Google Cloud Storage, Backblaze B2), gerencia snapshots e pol√≠ticas de reten√ß√£o. F√°cil de usar.
    *   **Contras**: Pode ser um pouco mais intensivo em CPU/mem√≥ria durante o backup devido √† deduplica√ß√£o e criptografia. Requer instala√ß√£o do bin√°rio `restic`.
    *   **Uso**: Excelente escolha para backups completos, versionados e criptografados, especialmente para destinos remotos ou cloud.

*   **Solu√ß√µes de Cloud Storage (com CLI/SDKs)**:
    *   **AWS S3 Sync, Azure AzCopy, Google Cloud gsutil rsync**:
        *   **Pr√≥s**: Integrado com os respectivos provedores de nuvem, escal√°vel, dur√°vel. Suportam sincroniza√ß√£o incremental.
        *   **Contras**: Espec√≠fico do provedor, custos associados ao armazenamento e transfer√™ncia. A criptografia precisa ser configurada (server-side ou client-side).
    *   **Uso**: Bom se o destino principal do backup for um provedor de nuvem espec√≠fico.

*   **Ferramentas de Backup de Volumes Docker**:
    *   Existem utilit√°rios que facilitam o backup de volumes Docker, geralmente envolvendo parar o container, executar um `docker cp` ou rodar um container tempor√°rio que acessa o volume e usa `tar` ou `rsync`. `restic` tamb√©m pode acessar dados de volumes se o caminho do host for conhecido.

**Escolha Recomendada para VV-Video-AI-System:**
*   **Para backups locais/NAS**: `rsync` para simplicidade em backups di√°rios r√°pidos de dados em constante mudan√ßa (como `input/`, `processed/`), ou `restic` para versionamento e deduplica√ß√£o mais robustos.
*   **Para backups off-site/cloud**: `restic` √© altamente recomendado devido √† sua criptografia, deduplica√ß√£o e suporte a m√∫ltiplos backends.

**Destino dos Backups:**
*   **Local**: Um disco r√≠gido secund√°rio no mesmo edge device (protege contra falha do disco prim√°rio, mas n√£o contra falha do dispositivo ou desastre local).
*   **NAS (Network Attached Storage)**: Um dispositivo de armazenamento na rede local (melhor que disco local, mas ainda vulner√°vel a desastres locais).
*   **Cloud Storage**: AWS S3, Google Cloud Storage, Azure Blob Storage, Backblaze B2 (protege contra desastres locais, oferece alta durabilidade).

√â recomendada uma estrat√©gia **3-2-1**: 3 c√≥pias dos dados, em 2 tipos de m√≠dia diferentes, com 1 c√≥pia off-site.

---

### 3. Frequ√™ncia, Reten√ß√£o e RPO/RTO

*   **RPO (Recovery Point Objective)**: Perda m√°xima de dados aceit√°vel. Quanto tempo de dados voc√™ pode perder?
*   **RTO (Recovery Time Objective)**: Tempo m√°ximo aceit√°vel para restaurar o servi√ßo ap√≥s uma falha.

| Tipo de Dado                             | RPO Sugerido | RTO Sugerido | Frequ√™ncia de Backup | Pol√≠tica de Reten√ß√£o (Exemplo GFS)                      |
| :--------------------------------------- | :----------- | :----------- | :------------------- | :----------------------------------------------------- |
| **Configura√ß√µes e Estado da Aplica√ß√£o**  | 1-4 horas    | 1-2 horas    | A cada 4 horas       | Di√°rios por 7 dias, semanais por 4 semanas, mensais por 3 meses |
| (e.g., `.env`, `docker-compose.yml`, `orchestrator_state`, `model_manifest.json`) |              |              |                      |                                                        |
| **Metadados Gerados**                    | 4-8 horas    | 2-4 horas    | A cada 8 horas       | Di√°rios por 7 dias, semanais por 4 semanas, mensais por 6 meses |
| (e.g., `analytic/`, `summaries/`, `loglines/`, `playlists/`) |              |              |                      |                                                        |
| **Dados de M√≠dia (`input/`, `processed/`)** | 24 horas     | 4-12 horas   | Diariamente          | Di√°rios por 7 dias, semanais por 4 semanas, mensais por 1-3 meses (depende do volume e custo) |
| **Logs da Aplica√ß√£o**                    | 24 horas     | Conforme necess√°rio | Diariamente          | Rotacionar localmente (logrotate), backup di√°rio dos arquivos rotacionados por 30 dias |

**Considera√ß√µes:**
*   **Backups incrementais/diferenciais** devem ser usados para minimizar o tempo de backup e o espa√ßo de armazenamento. `restic` faz isso eficientemente. `rsync` pode simular com `--link-dest`.
*   A frequ√™ncia pode ser ajustada com base na criticidade e taxa de mudan√ßa dos dados. Para `input/`, se os v√≠deos chegam continuamente, um RPO menor pode ser desejado.
*   Os custos de armazenamento em nuvem influenciar√£o a pol√≠tica de reten√ß√£o para grandes volumes de dados de m√≠dia.

---

### 4. Teste de Recupera√ß√£o de Dados

Backups n√£o testados s√£o apenas esperan√ßas. Testes regulares s√£o cruciais.

*   **Tipos de Testes:**
    1.  **Restaura√ß√£o de Arquivos/Diret√≥rios Espec√≠ficos:** Testar a capacidade de restaurar um subconjunto de dados (e.g., um diret√≥rio espec√≠fico de `processed/`, o arquivo de estado do `orchestrator.py`).
    2.  **Restaura√ß√£o Completa do Sistema (Simulada):**
        *   Em um ambiente de teste/staging (idealmente um edge device id√™ntico de reserva).
        *   Restaurar todos os dados cr√≠ticos e configura√ß√µes para este novo ambiente.
        *   Executar `install.sh` (se necess√°rio para depend√™ncias) e `bootstrap.py`.
        *   Iniciar os servi√ßos via `docker-compose up -d`.
        *   Verificar a funcionalidade completa do sistema (processamento de um v√≠deo de teste, acesso √†s UIs, etc.).
    3.  **Restaura√ß√£o de Cen√°rios Espec√≠ficos:**
        *   Simular falha do disco `VIDEO_STORAGE_ROOT`.
        *   Simular corrup√ß√£o do arquivo de estado do orquestrador.

*   **Frequ√™ncia dos Testes:**
    *   Restaura√ß√£o de arquivos espec√≠ficos: Mensalmente.
    *   Restaura√ß√£o completa simulada: Trimestralmente ou Semestralmente.
    *   Ap√≥s qualquer mudan√ßa significativa na estrat√©gia de backup ou nas ferramentas.

*   **Responsabilidade:** Designar um respons√°vel pela execu√ß√£o e documenta√ß√£o dos testes de recupera√ß√£o.
*   **Documenta√ß√£o:**
    *   Manter um "Guia de Recupera√ß√£o de Desastres" (DR Plan) que detalhe os passos para cada cen√°rio de restaura√ß√£o.
    *   Registrar os resultados de cada teste, incluindo tempo para restaurar, quaisquer problemas encontrados e as solu√ß√µes aplicadas.

---

### 5. Estrat√©gia de Backup Espec√≠fica por Componente

1.  **`${VIDEO_STORAGE_ROOT}` (M√≠dia e Metadados Gerados):**
    *   Usar `restic` ou `rsync` para backup incremental para um destino (NAS ou Cloud).
    *   **Exclus√µes:** Pode-se considerar excluir diret√≥rios tempor√°rios ou arquivos de cache que n√£o s√£o cr√≠ticos para a recupera√ß√£o.
    *   Considerar a ordem: `input/` e metadados (`analytic/`, `summaries/`, `loglines/`) s√£o geralmente mais cr√≠ticos para RPO do que `processed/` (que pode ser reconstru√≠do se `input/` e metadados existirem, embora demore).

2.  **Logs da Aplica√ß√£o:**
    *   `logrotate` deve ser configurado para rotacionar e comprimir logs localmente (como detalhado em `12.3`).
    *   Os arquivos de log rotacionados (e.g., `app.log.1.gz`, `cleanup.log.1.gz`) devem ser inclu√≠dos no backup di√°rio (e.g., com `restic` ou `rsync`).

3.  **Estado Persistente da Aplica√ß√£o:**
    *   **Arquivo de estado do `orchestrator.py` (`processed_videos.txt` ou `orchestrator_db.sqlite`):** Backup frequente √© vital.
        *   Se SQLite, usar `sqlite3 .backup` para um arquivo de backup antes de copiar, para garantir consist√™ncia.
        *   Incluir no backup de "Configura√ß√µes e Estado da Aplica√ß√£o".
    *   `model_manifest.json` e `.current_model_info.json`: Incluir no backup de "Configura√ß√µes e Estado da Aplica√ß√£o".

4.  **Arquivos de Configura√ß√£o:**
    *   A maioria est√° no Git. O backup principal √© o pr√≥prio reposit√≥rio Git (remoto).
    *   Arquivos gerados ou espec√≠ficos do host (`.env`, chaves SSL, crontab exportado) devem ser backupados.
    *   Para `.env` contendo segredos, o backup deve ser criptografado. `restic` faz isso por padr√£o. Se usar `rsync`, criptografar antes ou o destino deve ser seguro.

5.  **Docker Volumes Nomeados (se aplic√°vel):**
    *   Identificar volumes nomeados: `docker volume ls`.
    *   M√©todo:
        1.  Parar os containers que usam o volume (se poss√≠vel, para consist√™ncia).
        2.  Montar o volume em um container tempor√°rio e usar `tar` para criar um arquivo, depois fazer backup do arquivo.
            ```bash
            docker run --rm -v <volume_name>:/data -v /tmp/backups:/backup alpine tar czf /backup/<volume_name>.tar.gz -C /data .
            ```
        3.  `restic` pode fazer backup diretamente do caminho do host do volume (encontrado via `docker volume inspect <volume_name>`).

---

### 6. Exemplos de Comandos de Backup (Conceitual)

Estes s√£o exemplos conceituais e precisam ser adaptados.

*   **`rsync` (para backup local incremental de `VIDEO_STORAGE_ROOT`):**
    ```bash
    # Assumindo /mnt/backup_disk √© o destino
    VIDEO_STORAGE_ROOT="/opt/vv-video-ai-system/storage" # Exemplo
    BACKUP_DEST="/mnt/backup_disk/vv_video_ai_backup"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    LATEST_BACKUP_LINK="${BACKUP_DEST}/latest"
    CURRENT_BACKUP_DIR="${BACKUP_DEST}/${TIMESTAMP}"

    mkdir -p "${CURRENT_BACKUP_DIR}"
    rsync -avh --delete --checksum \
          --link-dest="${LATEST_BACKUP_LINK}" \
          "${VIDEO_STORAGE_ROOT}/" \
          "${CURRENT_BACKUP_DIR}/storage_root/"

    # Outros diret√≥rios...
    rsync -avh --delete "${CONFIG_DIR}/" "${CURRENT_BACKUP_DIR}/config/"

    # Atualizar o link simb√≥lico 'latest'
    rm -f "${LATEST_BACKUP_LINK}"
    ln -s "${CURRENT_BACKUP_DIR}" "${LATEST_BACKUP_LINK}"
    ```

*   **`restic` (para backup em S3, com criptografia e deduplica√ß√£o):**
    ```bash
    # Vari√°veis de ambiente para restic (AWS S3 exemplo)
    export AWS_ACCESS_KEY_ID="YOUR_AWS_KEY_ID"
    export AWS_SECRET_ACCESS_KEY="YOUR_AWS_SECRET_KEY"
    export RESTIC_REPOSITORY="s3:s3.amazonaws.com/your-vv-ai-backup-bucket"
    export RESTIC_PASSWORD="YOUR_STRONG_RESTIC_PASSWORD" # Guarde isso de forma segura!

    # Inicializar reposit√≥rio (apenas uma vez)
    # restic init

    # Backup
    VIDEO_STORAGE_ROOT="/opt/vv-video-ai-system/storage"
    CONFIG_FILES_DIR="/opt/vv-video-ai-system/configs_to_backup" # Um diret√≥rio com c√≥pias de .env, etc.
    ORCHESTRATOR_STATE_DIR="/opt/vv-video-ai-system/orchestrator_data"

    restic backup \
        "${VIDEO_STORAGE_ROOT}" \
        "${CONFIG_FILES_DIR}" \
        "${ORCHESTRATOR_STATE_DIR}" \
        "/opt/vv-video-ai-system/logs" \
        --tag edge_device_01 \
        --exclude='**.tmp' \
        --exclude='**/cache/**'

    # Aplicar pol√≠tica de reten√ß√£o (esquecer snapshots antigos)
    restic forget \
        --keep-daily 7 \
        --keep-weekly 4 \
        --keep-monthly 6 \
        --prune # Remove dados n√£o referenciados
    ```

---

### 7. Cen√°rios de Falha e Resposta

1.  **Falha de Disco Prim√°rio (Edge Device):**
    *   **Resposta**: Substituir o disco. Restaurar o sistema operacional base (se necess√°rio). Restaurar todos os dados cr√≠ticos e configura√ß√µes do backup mais recente para o novo disco. Executar `install.sh` e `bootstrap.py`. Iniciar servi√ßos.
    *   **RTO Impactado**: Tempo para adquirir e instalar novo disco + tempo de restaura√ß√£o dos dados.

2.  **Dele√ß√£o Acidental de Arquivos/Diret√≥rios:**
    *   **Resposta**: Identificar os arquivos/diret√≥rios afetados. Restaurar apenas esses itens do backup mais recente relevante.
    *   **RTO Impactado**: R√°pido, dependendo do tamanho e da ferramenta de restaura√ß√£o.

3.  **Corrup√ß√£o de Dados (e.g., arquivo de estado do orquestrador, banco de dados SQLite):**
    *   **Resposta**: Restaurar a vers√£o mais recente e √≠ntegra do arquivo espec√≠fico do backup. Pode ser necess√°rio investigar a causa da corrup√ß√£o.
    *   **RTO Impactado**: R√°pido.

4.  **Falha Completa do Edge Device (Hardware):**
    *   **Resposta**: Provisionar um novo edge device. Restaurar o sistema operacional base. Restaurar todos os dados e configura√ß√µes do backup off-site. Executar `install.sh` e `bootstrap.py`. Configurar rede. Iniciar servi√ßos.
    *   **RTO Impactado**: Significativo, depende da disponibilidade de hardware e velocidade de restaura√ß√£o do backup completo.

5.  **Ataque de Ransomware (no Edge Device ou no local de backup se n√£o estiver isolado/imut√°vel):**
    *   **Resposta**: Isolar o dispositivo. N√£o pagar o resgate. Reconstruir o sistema a partir de um backup limpo e verificado (anterior ao incidente) em hardware limpo/reformatado. Investigar o vetor de ataque.
    *   **Considera√ß√£o**: Backups imut√°veis (e.g., S3 Object Lock) ou backups "air-gapped" s√£o defesas importantes.

---

### 8. Considera√ß√µes Adicionais

*   **Monitoramento de Backup:**
    *   Os scripts de backup devem logar seu status (sucesso, falha, arquivos backupados, dura√ß√£o).
    *   Configurar alertas para falhas de backup.
*   **Seguran√ßa dos Backups:**
    *   Proteger o acesso ao local de armazenamento dos backups (f√≠sico e l√≥gico).
    *   Usar criptografia para backups, especialmente se armazenados em nuvem ou em m√≠dias transport√°veis (`restic` faz isso por padr√£o).
    *   Gerenciar chaves de criptografia de backup de forma segura.
*   **Largura de Banda (para backups off-site):**
    *   Edge devices podem ter conex√µes de internet limitadas. Agendar backups off-site para hor√°rios de baixa utiliza√ß√£o.
    *   Backups incrementais e com deduplica√ß√£o (`restic`) ajudam a minimizar a quantidade de dados transferidos.
*   **Custo de Armazenamento:** Monitorar os custos, especialmente com provedores de nuvem, e ajustar pol√≠ticas de reten√ß√£o conforme necess√°rio.
*   **Documenta√ß√£o:** Manter o Guia de Recupera√ß√£o de Desastres (DR Plan) atualizado e acess√≠vel.

---

### 9. Impacto Esperado

*   **Resili√™ncia do Sistema:** Capacidade de recuperar o `VV-Video-AI-System` e seus dados cr√≠ticos ap√≥s diversos cen√°rios de falha.
*   **Continuidade dos Neg√≥cios:** Minimiza√ß√£o do tempo de inatividade (RTO) e da perda de dados (RPO) em caso de incidentes.
*   **Confiabilidade:** Aumento da confian√ßa na integridade e disponibilidade dos dados do sistema.
*   **Conformidade:** Atendimento a poss√≠veis requisitos de reten√ß√£o de dados e recupera√ß√£o de desastres.

---

This detailed plan for `12.8` should provide a solid foundation for implementing a robust backup and recovery strategy. We can refine any part further if you wish.
