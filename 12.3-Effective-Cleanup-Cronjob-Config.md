# 12.3 üßπ Configura√ß√£o Efetiva do Cronjob `cleanup_old_files.py`

**Objetivo**: Assegurar que a limpeza de arquivos antigos ocorra efetivamente e de forma segura, indo al√©m da configura√ß√£o inicial de `--dry-run` para gerenciar ativamente o espa√ßo em disco.

**Status Atual no Checklist**: `| Configura√ß√£o Efetiva do cleanup_old_files.py | üìù A√ß√£o Requerida |`

---

## 1. Vis√£o Geral e Justificativa

O script `cleanup_old_files.py` √© essencial para a manuten√ß√£o a longo prazo do `VV-Video-AI-System`, prevenindo o esgotamento de espa√ßo em disco que poderia levar √† interrup√ß√£o dos servi√ßos. A configura√ß√£o de instala√ß√£o (`install.sh`) atualmente define um cronjob com `--dry-run`, que √© √∫til para testes e verifica√ß√£o, mas n√£o executa a limpeza real. Esta se√ß√£o detalha como configurar e gerenciar o cronjob para limpeza efetiva.

## 2. Entendendo `cleanup_old_files.py`

Presume-se que o script `scripts/cleanup_old_files.py` aceite os seguintes argumentos (ou similares):

*   `--days N`: Especifica a idade m√≠nima (em dias) dos arquivos a serem exclu√≠dos.
*   `--dirs /path/to/dir1,/path/to/dir2`: Lista de diret√≥rios onde a limpeza ser√° aplicada.
*   `--dry-run`: Simula a execu√ß√£o, listando os arquivos que seriam exclu√≠dos, mas sem exclu√≠-los.
*   `--log-file /path/to/logfile.log`: (Opcional, mas recomendado) Especifica um arquivo para registrar as a√ß√µes de limpeza.
*   `--min-free-space GB_OR_%`: (Opcional, avan√ßado) Define um limite m√≠nimo de espa√ßo livre. A limpeza s√≥ ocorre se o espa√ßo livre estiver abaixo desse limite.
*   `--exclude-patterns "*.important,temp_*"`: (Opcional, avan√ßado) Padr√µes de arquivos a serem exclu√≠dos da limpeza, mesmo que atendam aos crit√©rios de idade.

## 3. Tarefas Detalhadas

### 3.1. Revisar a Pol√≠tica de Reten√ß√£o de Dados

Antes de ativar a limpeza, defina claramente por quanto tempo os dados em cada diret√≥rio devem ser mantidos.

*   **Diret√≥rios a Considerar**:
    *   `${VIDEO_STORAGE_ROOT}/input/`: V√≠deos aguardando processamento. Geralmente n√£o se limpa por idade, mas por status de processamento.
    *   `${VIDEO_STORAGE_ROOT}/raw/`: C√≥pias brutas. Pol√≠tica de reten√ß√£o pode variar.
    *   `${VIDEO_STORAGE_ROOT}/processed/`: V√≠deos processados. Podem ser limpos ap√≥s um certo tempo.
    *   `${VIDEO_STORAGE_ROOT}/tv_curado/`: Playlists ou v√≠deos para TV. A limpeza aqui deve ser coordenada com `tv_scheduler.py`.
    *   `${VIDEO_STORAGE_ROOT}/analytic/`: JSONs de an√°lise. Reten√ß√£o conforme necessidade de hist√≥rico.
    *   `${VIDEO_STORAGE_ROOT}/summaries/`: Sum√°rios da IA. Reten√ß√£o conforme necessidade de hist√≥rico.
    *   `${VIDEO_STORAGE_ROOT}/loglines/`: LogLines. Reten√ß√£o conforme requisitos de auditoria.
    *   `${VIDEO_STORAGE_ROOT}/playlists/`: Playlists geradas. Podem ser limpas frequentemente, pois s√£o regeneradas.
    *   `${VIDEO_STORAGE_ROOT}/corrupted/`: Arquivos problem√°ticos. Podem ser inspecionados e limpos periodicamente.
    *   `logs/app.log` e outros logs da aplica√ß√£o: Rotacionar e limpar logs antigos.
    *   Logs de containers Docker (se n√£o gerenciados por um sistema central de logs).

*   **Exemplo de Pol√≠tica de Reten√ß√£o**:
    *   `processed/`: Manter por 30 dias.
    *   `analytic/`: Manter por 90 dias.
    *   `summaries/`: Manter por 90 dias.
    *   `loglines/`: Manter por 180 dias (auditoria).
    *   `corrupted/`: Manter por 7 dias para inspe√ß√£o, depois limpar.
    *   `logs/app.log`: Rotacionar diariamente, manter arquivos rotacionados por 14 dias.

### 3.2. Configurar o Cronjob para Limpeza Efetiva

Modificar o cronjob existente ou adicionar novos para executar `cleanup_old_files.py` *sem* a flag `--dry-run`.

*   **Acesso ao Crontab**:
    Edite o crontab do usu√°rio que deve executar o script (geralmente o mesmo usu√°rio que executa a aplica√ß√£o, ou root se necess√°rio para permiss√µes).
    ```bash
    sudo crontab -e # Para o usu√°rio root
    # ou
    crontab -e # Para o usu√°rio atual
    ```

*   **Exemplo de Configura√ß√£o de Cronjob**:

    ```cron
    # Limpeza di√°ria de arquivos processados mais antigos que 30 dias
    # Roda todos os dias √†s 03:00
    0 3 * * * /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 30 --dirs "${VIDEO_STORAGE_ROOT}/processed" --log-file /opt/vv-video-ai-system/logs/cleanup_processed.log >> /opt/vv-video-ai-system/logs/cron_cleanup_processed.log 2>&1

    # Limpeza semanal de arquivos de an√°lise e sum√°rios mais antigos que 90 dias
    # Roda todo Domingo √†s 03:30
    30 3 * * 0 /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 90 --dirs "${VIDEO_STORAGE_ROOT}/analytic,${VIDEO_STORAGE_ROOT}/summaries" --log-file /opt/vv-video-ai-system/logs/cleanup_metadata.log >> /opt/vv-video-ai-system/logs/cron_cleanup_metadata.log 2>&1

    # Limpeza mensal de LogLines mais antigas que 180 dias
    # Roda no primeiro dia do m√™s √†s 04:00
    0 4 1 * * /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 180 --dirs "${VIDEO_STORAGE_ROOT}/loglines" --log-file /opt/vv-video-ai-system/logs/cleanup_loglines.log >> /opt/vv-video-ai-system/logs/cron_cleanup_loglines.log 2>&1

    # Limpeza di√°ria de arquivos corrompidos mais antigos que 7 dias
    0 2 * * * /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 7 --dirs "${VIDEO_STORAGE_ROOT}/corrupted" --log-file /opt/vv-video-ai-system/logs/cleanup_corrupted.log >> /opt/vv-video-ai-system/logs/cron_cleanup_corrupted.log 2>&1

    # Manter o cronjob de dry-run para verifica√ß√£o (opcional, mas pode ser √∫til)
    # Roda a cada hora para verificar o que seria limpo no pr√≥ximo ciclo de 30 dias em 'processed'
    # 0 * * * * /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 30 --dirs "${VIDEO_STORAGE_ROOT}/processed" --dry-run --log-file /opt/vv-video-ai-system/logs/cleanup_processed_dryrun.log >> /opt/vv-video-ai-system/logs/cron_cleanup_processed_dryrun.log 2>&1
    ```

*   **Notas sobre a Configura√ß√£o**:
    *   **Caminho Completo**: Use caminhos completos para `python3` e para o script.
    *   **Vari√°vel `VIDEO_STORAGE_ROOT`**: Esta vari√°vel deve estar definida no ambiente do cron ou substitu√≠da pelo caminho absoluto. √â mais seguro usar o caminho absoluto diretamente no cronjob. Ex: `/mnt/video_storage/processed`.
    *   **Redirecionamento de Sa√≠da**:
        *   `--log-file /path/to/script_specific.log`: Para que o script `cleanup_old_files.py` registre suas pr√≥prias a√ß√µes detalhadas.
        *   `>> /path/to/cron_specific.log 2>&1`: Para capturar a sa√≠da padr√£o (stdout) e erros padr√£o (stderr) do pr√≥prio comando cron, √∫til para depurar problemas com a execu√ß√£o do cronjob em si.
    *   **Permiss√µes**: O usu√°rio do cronjob deve ter permiss√£o de escrita nos diret√≥rios de log e permiss√£o de exclus√£o nos diret√≥rios alvo.
    *   **Hor√°rios**: Escolha hor√°rios de baixa atividade para executar os scripts de limpeza.

### 3.3. Gerenciamento de Logs da Aplica√ß√£o (`logs/app.log`)

A limpeza de `logs/app.log` e outros logs gerados pela aplica√ß√£o geralmente √© feita por uma ferramenta de rota√ß√£o de logs como `logrotate`.

*   **Configura√ß√£o do `logrotate`**:
    Crie um arquivo de configura√ß√£o em `/etc/logrotate.d/vv-video-ai`:

    ```logrotate name=vv-video-ai.logrotate.conf
    /opt/vv-video-ai-system/logs/app.log
    /opt/vv-video-ai-system/logs/cleanup_*.log
    /opt/vv-video-ai-system/logs/cron_*.log
    # Adicione outros arquivos de log conforme necess√°rio
    {
        daily                    # Rotacionar diariamente
        rotate 14                # Manter 14 arquivos de log rotacionados
        compress                 # Comprimir arquivos de log rotacionados (gzip)
        delaycompress            # Atrasar a compress√£o para o pr√≥ximo ciclo (evita problemas com logs ativos)
        missingok                # N√£o gerar erro se o arquivo de log n√£o existir
        notifempty               # N√£o rotacionar se o log estiver vazio
        create 0640 appuser appgroup # Criar novo arquivo de log com permiss√µes e dono/grupo espec√≠ficos
                                     # Substitua appuser e appgroup pelos corretos
        sharedscripts            # Executar scripts (postrotate/prerotate) apenas uma vez, n√£o para cada log
        postrotate
            # Comandos a serem executados ap√≥s a rota√ß√£o
            # Ex: Sinalizar para a aplica√ß√£o reabrir seus arquivos de log, se necess√°rio
            # systemctl kill -s HUP vv-video-ai.service # Exemplo se a app suportar SIGHUP para reabrir logs
        endscript
    }
    ```
    `logrotate` √© tipicamente executado diariamente por um cronjob do sistema (verifique `/etc/cron.daily/logrotate`).

### 3.4. Teste e Monitoramento

*   **Teste Inicial com `--dry-run`**: Antes de remover a flag `--dry-run` de um cronjob, execute-o manualmente com e sem a flag para confirmar que ele se comporta como esperado.
    ```bash
    # Simula√ß√£o
    /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 30 --dirs "/mnt/video_storage/processed" --dry-run --log-file /tmp/dry_run_test.log
    cat /tmp/dry_run_test.log

    # Execu√ß√£o real (CUIDADO!)
    # /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 30 --dirs "/mnt/video_storage/processed" --log-file /tmp/real_run_test.log
    # cat /tmp/real_run_test.log
    ```
*   **Verificar Logs**: Monitore regularmente os arquivos de log especificados na op√ß√£o `--log-file` e os logs do cron (`cron_*.log`) para garantir que a limpeza est√° ocorrendo corretamente e sem erros.
*   **Alertas de Espa√ßo em Disco**: Configure um sistema de monitoramento (e.g., Prometheus com Alertmanager, Nagios, Zabbix) para alertar se o espa√ßo em disco atingir n√≠veis cr√≠ticos, indicando uma poss√≠vel falha ou inadequa√ß√£o da pol√≠tica de limpeza.

## 4. Considera√ß√µes Adicionais

*   **Impacto no Desempenho**: Opera√ß√µes de exclus√£o de muitos arquivos podem ser intensivas em I/O. Agende-as para hor√°rios de baixa atividade.
*   **Seguran√ßa**: Certifique-se de que o script `cleanup_old_files.py` √© robusto contra a exclus√£o acidental de arquivos importantes (e.g., n√£o permitir `--days 0` ou `--dirs /` sem prote√ß√µes extremas).
*   **Backup Antes da Limpeza**: Para dados extremamente cr√≠ticos, considere um backup antes da execu√ß√£o da limpeza, especialmente durante os est√°gios iniciais de implementa√ß√£o da pol√≠tica de reten√ß√£o.
*   **Idempot√™ncia**: O script de limpeza deve ser idempotente, ou seja, execut√°-lo m√∫ltiplas vezes com os mesmos par√¢metros n√£o deve causar efeitos colaterais negativos.

## 5. Walkthrough: Implementando Limpeza para `processed/`

1.  **Definir Pol√≠tica**: Arquivos em `/mnt/video_storage/processed/` devem ser mantidos por 60 dias.
2.  **Testar Script Manualmente (Dry Run)**:
    ```bash
    /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 60 --dirs "/mnt/video_storage/processed" --dry-run --log-file /tmp/cleanup_processed_dry.log
    echo "Conte√∫do do log de dry-run:"
    cat /tmp/cleanup_processed_dry.log
    ```
    Verifique se os arquivos listados s√£o os esperados.
3.  **Testar Script Manualmente (Execu√ß√£o Real em um Subconjunto ou Diret√≥rio de Teste)**:
    Crie um diret√≥rio de teste com arquivos de diferentes idades, e.g., `/mnt/video_storage/test_cleanup/processed_test/`.
    ```bash
    # CUIDADO: Isto ir√° deletar arquivos no diret√≥rio de teste!
    /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 60 --dirs "/mnt/video_storage/test_cleanup/processed_test" --log-file /tmp/cleanup_processed_real_test.log
    echo "Conte√∫do do log de execu√ß√£o real (teste):"
    cat /tmp/cleanup_processed_real_test.log
    ```
    Verifique se os arquivos corretos foram exclu√≠dos.
4.  **Adicionar Cronjob**:
    Edite o crontab (`sudo crontab -e`):
    ```cron
    # Limpeza di√°ria de arquivos processados mais antigos que 60 dias
    # Roda todos os dias √†s 02:30 AM
    30 2 * * * /usr/bin/python3 /opt/vv-video-ai-system/scripts/cleanup_old_files.py --days 60 --dirs "/mnt/video_storage/processed" --log-file /opt/vv-video-ai-system/logs/cleanup_processed.log >> /opt/vv-video-ai-system/logs/cron_cleanup_processed.log 2>&1
    ```
    (Lembre-se de substituir `/mnt/video_storage/` pelo valor real de `${VIDEO_STORAGE_ROOT}`).
5.  **Configurar `logrotate`**:
    Adicione `/opt/vv-video-ai-system/logs/cleanup_processed.log` e `/opt/vv-video-ai-system/logs/cron_cleanup_processed.log` ao arquivo de configura√ß√£o do `logrotate` (e.g., `/etc/logrotate.d/vv-video-ai`).
6.  **Monitorar**: Nos dias seguintes, verifique os logs e o espa√ßo em disco para confirmar que a limpeza est√° funcionando conforme o esperado.

## 6. Impacto Esperado

*   Gerenciamento proativo e autom√°tico do espa√ßo em disco.
*   Preven√ß√£o de falhas de servi√ßo devido ao esgotamento de disco.
*   Conformidade com pol√≠ticas de reten√ß√£o de dados.

---

**Pr√≥ximo Passo**: Revisar esta configura√ß√£o. Se estiver tudo OK, prosseguiremos para o item 12.4 sobre a persist√™ncia de estado do `orchestrator.py`.