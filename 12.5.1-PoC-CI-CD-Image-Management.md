# 12.5.1 üöÄ Prova de Conceito (PoC): CI/CD e Gerenciamento de Imagens para Servi√ßos Selecionados

**Objetivo**: Implementar e validar o fluxo de CI/CD e gerenciamento de imagens com um registro privado para 1 ou 2 servi√ßos do `VV-Video-AI-System` como uma Prova de Conceito (PoC). Isso permitir√° testar a abordagem antes de aplic√°-la a todos os servi√ßos.

**Servi√ßos Selecionados para a PoC (Exemplo)**:
1.  `scene_scanner`: Um servi√ßo Python com depend√™ncias e l√≥gica de aplica√ß√£o.
2.  `agent_dvr`: Potencialmente um servi√ßo mais simples, para variar o escopo.

---

## 1. Pr√©-requisitos

*   Reposit√≥rio do `VV-Video-AI-System` hospedado no GitHub.
*   Conta Docker Hub (se for usar como registro alternativo) ou permiss√µes para usar o GitHub Container Registry (GHCR) na sua conta/organiza√ß√£o GitHub.
*   Acesso para modificar o `docker-compose.yml` e configurar o Watchtower no ambiente de teste/produ√ß√£o.
*   Familiaridade b√°sica com GitHub Actions.

## 2. Passos da Prova de Conceito (PoC)

### Passo 1: Configurar o GitHub Container Registry (GHCR)

O GHCR √© ativado por padr√£o para reposit√≥rios p√∫blicos. Para reposit√≥rios privados, pode ser necess√°rio habilit√°-lo nas configura√ß√µes do reposit√≥rio ou da organiza√ß√£o. As imagens ser√£o nomeadas como `ghcr.io/<SEU_USUARIO_OU_ORG>/<NOME_IMAGEM>`.

*   **A√ß√£o**: Verifique as configura√ß√µes do seu reposit√≥rio GitHub em `Settings > Packages > Container registry`. Garanta que est√° habilitado.
*   **Permiss√µes**:
    *   O `GITHUB_TOKEN` (dispon√≠vel automaticamente nos workflows do GitHub Actions) ter√° permiss√£o para fazer push de imagens para o GHCR se o workflow tiver `permissions: packages: write`.
    *   Voc√™ precisar√° de um Personal Access Token (PAT) com escopo `read:packages` para permitir que o Watchtower (ou voc√™ manualmente) fa√ßa pull das imagens do GHCR no seu servidor.

### Passo 2: Criar um Personal Access Token (PAT) para Watchtower/Docker Pull

1.  V√° para o seu GitHub `Settings > Developer settings > Personal access tokens > Tokens (classic)`.
2.  Clique em "Generate new token" (ou "Generate new token (classic)").
3.  D√™ um nome (e.g., `GHCR_PULL_VV_AI_SYSTEM`).
4.  Selecione a expira√ß√£o.
5.  Selecione o escopo: `read:packages`.
6.  Clique em "Generate token".
7.  **Copie o token imediatamente.** Voc√™ n√£o o ver√° novamente. Guarde-o de forma segura.

### Passo 3: Criar o Workflow do GitHub Actions para os Servi√ßos da PoC

Crie um novo arquivo de workflow, por exemplo, `.github/workflows/poc-docker-publish.yml`:

```yaml name=poc-docker-publish.yml
name: PoC Docker Publish CI

on:
  push:
    branches: [ "main" ] # Ou uma feature branch espec√≠fica para a PoC
    paths: # Acionar apenas se houver mudan√ßas nos diret√≥rios dos servi√ßos da PoC
      - 'scan_video/**'
      - 'agent_dvr/**'
  workflow_dispatch: # Permite acionamento manual

jobs:
  build_and_publish_poc:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Necess√°rio para push para GHCR

    strategy:
      matrix:
        service:
          - name: scene_scanner # Nome do servi√ßo para a imagem (vv-scene_scanner)
            path: ./scan_video  # Path para o Dockerfile e contexto de build
          - name: agent_dvr
            path: ./agent_dvr

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # Seu nome de usu√°rio ou organiza√ß√£o GitHub
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date for tagging
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Extract Owner (lowercase)
        id: owner
        run: echo "value=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build and push Docker image for ${{ matrix.service.name }}
        id: build_image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          file: ${{ matrix.service.path }}/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.owner.outputs.value }}/vv-${{ matrix.service.name }}:latest
            ghcr.io/${{ steps.owner.outputs.value }}/vv-${{ matrix.service.name }}:${{ github.sha }}
            ghcr.io/${{ steps.owner.outputs.value }}/vv-${{ matrix.service.name }}:build-${{ steps.date.outputs.date }}
          # platforms: linux/amd64 # Adicionar se precisar de build para uma arquitetura espec√≠fica
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Print Image Details
        run: |
          echo "Pushed image for ${{ matrix.service.name }}: ghcr.io/${{ steps.owner.outputs.value }}/vv-${{ matrix.service.name }}:latest"
          echo "All tags: ${{ steps.build_image.outputs.tags }}"